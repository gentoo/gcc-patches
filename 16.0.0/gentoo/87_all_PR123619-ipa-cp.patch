https://gcc.gnu.org/PR123587
https://gcc.gnu.org/PR123619
https://gcc.gnu.org/pipermail/gcc-patches/2025-December/702974.html
--- a/gcc/cgraph.h
+++ b/gcc/cgraph.h
@@ -1684,8 +1684,11 @@ public:
 
   /* Return TRUE if context is fully useless.  */
   bool useless_p () const;
-  /* Return TRUE if this context conveys the same information as X.  */
-  bool equal_to (const ipa_polymorphic_call_context &x) const;
+  /* Return TRUE if this context conveys the same information as X.  If
+     STRICT_SPECULATION is true, compare the speculative part even when it is
+     inconsistent.  */
+  bool equal_to (const ipa_polymorphic_call_context &x,
+		 bool strict_speculation = false) const;
 
   /* Dump human readable context to F.  If NEWLINE is true, it will be
      terminated by a newline.  */
--- a/gcc/ipa-cp.cc
+++ b/gcc/ipa-cp.cc
@@ -2026,7 +2026,7 @@ static bool
 values_equal_for_ipcp_p (ipa_polymorphic_call_context x,
 			 ipa_polymorphic_call_context y)
 {
-  return x.equal_to (y);
+  return x.equal_to (y, true);
 }
 
 
--- a/gcc/ipa-polymorphic-call.cc
+++ b/gcc/ipa-polymorphic-call.cc
@@ -2368,11 +2368,13 @@ ipa_polymorphic_call_context::possible_dynamic_type_change (bool in_poly_cdtor,
     maybe_in_construction = true;
 }
 
-/* Return TRUE if this context conveys the same information as OTHER.  */
+/* Return TRUE if this context conveys the same information as X.  If
+   STRICT_SPECULATION is true, compare the speculative part even when it is
+   inconsistent.  */
 
 bool
 ipa_polymorphic_call_context::equal_to
-    (const ipa_polymorphic_call_context &x) const
+(const ipa_polymorphic_call_context &x, bool strict_speculation) const
 {
   if (useless_p ())
     return x.useless_p ();
@@ -2397,8 +2399,11 @@ ipa_polymorphic_call_context::equal_to
 
 
   if (speculative_outer_type
-      && speculation_consistent_p (speculative_outer_type, speculative_offset,
-				   speculative_maybe_derived_type, NULL_TREE))
+      && (strict_speculation
+	  || speculation_consistent_p (speculative_outer_type,
+				       speculative_offset,
+				       speculative_maybe_derived_type,
+				       NULL_TREE)))
     {
       if (!x.speculative_outer_type)
 	return false;
@@ -2412,10 +2417,11 @@ ipa_polymorphic_call_context::equal_to
 	return false;
     }
   else if (x.speculative_outer_type
-	   && x.speculation_consistent_p (x.speculative_outer_type,
-					  x.speculative_offset,
-				  	  x.speculative_maybe_derived_type,
-					  NULL))
+	   && (strict_speculation
+	       || x.speculation_consistent_p (x.speculative_outer_type,
+					      x.speculative_offset,
+					      x.speculative_maybe_derived_type,
+					      NULL)))
     return false;
 
   return true;
-- 
2.51.1

